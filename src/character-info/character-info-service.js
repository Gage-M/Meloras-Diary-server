const  xss  = require('xss');




/*
                                                          Table "public.character_info"
       Column       |           Type           | Collation | Nullable |             Default              | Storage  | Stats target | Description
--------------------+--------------------------+-----------+----------+----------------------------------+----------+--------------+-------------
 id                 | integer                  |           | not null | generated by default as identity | plain    |              |
 player_id          | integer                  |           | not null |                                  | plain    |              |
 date_created       | timestamp with time zone |           | not null | now()                            | plain    |              |
 character_name     | text                     |           | not null |                                  | extended |              |
 race               | text                     |           | not null |                                  | extended |              |
 background         | text                     |           | not null |                                  | extended |              |
 alignment          | alignment_choice         |           | not null | 'Neutral'::alignment_choice      | plain    |              |
 gender             | gender_choice            |           | not null | 'Female'::gender_choice          | plain    |              |
 personality_traits | text                     |           | not null |                                  | extended |              |
 ideals             | text                     |           | not null |                                  | extended |              |
 fears              | text                     |           | not null |                                  | extended |              |
 notes              | text                     |           | not null |                                  | extended |              |

 
oof = {
    select(
        'char.date_created',
        'char.character_name',
        'char.race',
        'char.background',
        'char.alignment',
        'char.gender',
        'char.personality_traits',
        'char.ideals',
        'char.fears',
        'char.notes',

           for all => ,
        db.raw('count(DISTINCT char) AS number_of_character'),
        db.raw(
          `json_strip_nulls(
                json_build_object(
                    'user.user_name',
                )
            )AS creator`
        )
      )
      .leftJoin('diary_users AS user',
        'char.player_id',
        'user.id'
      )
      .groupBy('char.id','user.id');

       for target => .select('*',
        db.raw('count(DISTINCT char) AS number_of_character'),
        db.raw(
          `json_strip_nulls(
              json_build_object(
                  'user.user_name',
              )
          )AS creator`
        )
      )
      .leftJoin('diary_users AS user',
        'char.player_id',
        'user.id'
      )
    )
}

*/

const CharacterInfoService = {
  getAllCharacters(db){
    return db
      .from('character_info AS char')
      .select();
  },
  getCharacterById(db,id){
    return db
      .from('character_info AS char')
      .select()
      .where('char.id', id)
      .first();
  },
  insertNewCharacter(db, newContent){
    return db 
      .insert(newContent)
      .into('character_info')
      .returning('*')
      .then(([char])=> char)
      .then(char => CharacterInfoService.getCharacterById(db,char.id));
  },
  serializeCharacter(char){
    return{
      id:char.id ,
      player_id: char.player_id ,
      date_created: new Date(char.date_created) ,
      character_name: xss(char.character_name) ,
      race: xss(char.race) ,
      background: xss(char.background) ,
      alignment: xss(char.alignment) ,
      gender : xss(char.gender),
      personality_traits: xss(char.personality_traits) ,
      ideals: xss(char.ideals),
      fears:xss( char.fears),
      notes: xss(char.notes)
    };
  },
  updateChar(db,id,updateContent){
    return db('character_info')
      .where({id})
      .update(updateContent);
  },
  deleteChar(db,id){
    return db('character_info')
      .where({id})
      .delete();
  }
  
};
  
module.exports = CharacterInfoService;